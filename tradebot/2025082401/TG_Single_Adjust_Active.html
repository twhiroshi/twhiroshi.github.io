<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單幣-修改倉位(執行中)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 20px;
            line-height: 1.4;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .info-group {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 8px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }
        .info-label {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
            margin-bottom: 3px;
        }
        .info-value {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 6px;
            font-size: 16px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            box-sizing: border-box;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .btn-danger {
            background-color: #ff3b30;
            color: white;
        }
        .btn-secondary {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }
        .version {
            text-align: center;
            color: var(--tg-theme-hint-color, #999999);
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>單幣-修改倉位(執行中)(ver:2025082401)</h2>
        
        <!-- 訂單資訊 (只顯示) -->
        <div class="info-group">
            <h3>訂單資訊</h3>
            <div class="info-label">訂單編號</div>
            <div class="info-value" id="orderId"></div>
            
            <div class="info-label">交易標的</div>
            <div class="info-value" id="symbolDirection"></div>
            
            <div class="info-label">當前數量</div>
            <div class="info-value" id="currentQuantity"></div>
            
            <div class="info-label">平均成本</div>
            <div class="info-value" id="averageCost"></div>
            
            <div class="info-label">當前停損價格</div>
            <div class="info-value" id="currentStopLoss"></div>
            
            <div class="info-label">槓桿倍數</div>
            <div class="info-value" id="leverage"></div>
            
            <div class="info-label">週期</div>
            <div class="info-value" id="atrPeriod"></div>
            
            <div class="info-label">加碼設定</div>
            <div class="info-value" id="enableScaling"></div>
            
            <div class="info-label">已實現盈虧</div>
            <div class="info-value" id="realizedProfit"></div>
        </div>
        
        <!-- 可修改參數 -->
        <div class="form-group">
            <label for="adjustATR">ATR 倍數 (影響動態停損調整)</label>
            <input type="number" id="adjustATR" step="0.1" min="0.1" max="5.0" placeholder="輸入 ATR 倍數">
        </div>
        
        <!-- 操作按鈕 -->
        <div class="button-group">
            <button class="btn btn-primary" onclick="submitModification()">確認修改</button>
        </div>
        
        <div class="button-group">
            <button class="btn btn-danger" onclick="manualClose()">手動平倉</button>
            <button class="btn btn-secondary" onclick="cancelOperation()">取消</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let orderData = {};
        
        function initForm() {
            tg.ready();
            tg.expand();
            
            // 從 URL 參數獲取訂單資訊
            const urlParams = new URLSearchParams(window.location.search);
            orderData = {
                id: urlParams.get('id') || '',
                symbol: urlParams.get('symbol') || '',
                direction: urlParams.get('direction') || '',
                quantity: urlParams.get('quantity') || '',
                averageCost: urlParams.get('averageCost') || '',
                currentStopLoss: urlParams.get('currentStopLoss') || '',
                leverage: urlParams.get('leverage') || '',
                period: urlParams.get('period') || '',
                enableScaling: urlParams.get('enableScaling') || '',
                realizedProfit: urlParams.get('realizedProfit') || '',
                adjustATR: urlParams.get('adjustATR') || ''
            };
            
            // 填入訂單資訊
            document.getElementById('orderId').textContent = orderData.id;
            document.getElementById('symbolDirection').textContent = `${orderData.symbol} (${orderData.direction === 'long' ? '作多' : '作空'})`;
            document.getElementById('currentQuantity').textContent = orderData.quantity;
            document.getElementById('averageCost').textContent = orderData.averageCost;
            document.getElementById('currentStopLoss').textContent = orderData.currentStopLoss;
            document.getElementById('leverage').textContent = `${orderData.leverage}x`;
            document.getElementById('atrPeriod').textContent = orderData.period;
            document.getElementById('enableScaling').textContent = orderData.enableScaling === 'true' ? '已啟用' : '未啟用';
            document.getElementById('realizedProfit').textContent = `$${orderData.realizedProfit}`;
            
            // 設定當前 ATR 倍數
            document.getElementById('adjustATR').value = orderData.adjustATR;
        }
        
        function submitModification() {
            const adjustATR = document.getElementById('adjustATR').value;
            
            if (!adjustATR || adjustATR < 0.1 || adjustATR > 5.0) {
                alert('請輸入有效的 ATR 倍數 (0.1-5.0)');
                return;
            }
            
            const confirmMessage = `確認修改 ATR 倍數為 ${adjustATR}？`;
            if (confirm(confirmMessage)) {
                const data = `id=${orderData.id}&adjustATR=${adjustATR}`;
                tg.sendData(data);
            }
        }
        
        function manualClose() {
            const confirmMessage = `確認手動平倉 ${orderData.symbol} ${orderData.direction === 'long' ? '作多' : '作空'} 部位？`;
            if (confirm(confirmMessage)) {
                const data = `closeOrder=${orderData.id}`;
                tg.sendData(data);
            }
        }
        
        function cancelOperation() {
            tg.sendData('cancelOperation');
        }
        
        // 初始化表單
        window.onload = initForm;
    </script>
</body>
</html>