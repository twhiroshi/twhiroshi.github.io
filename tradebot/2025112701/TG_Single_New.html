<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單幣-建立新單</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 20px;
            line-height: 1.4;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--tg-theme-secondary-bg-color, #f8f8f8);
            color: var(--tg-theme-text-color, #000000);
            box-sizing: border-box;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #0088cc);
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        .submit-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
        }
        .cancel-btn {
            width: 100%;
            padding: 15px;
            background-color: transparent;
            color: var(--tg-theme-destructive-text-color, #ff3b30);
            border: 1px solid var(--tg-theme-destructive-text-color, #ff3b30);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
        }
        .form-row {
            display: flex;
            gap: 10px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .error-text {
            color: var(--tg-theme-destructive-text-color, #ff3b30);
            font-size: 14px;
            margin-top: 5px;
        }
        .price-type-info {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 3px;
        }
        .validation-info {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 3px;
            padding: 8px;
            background-color: var(--tg-theme-secondary-bg-color, #f8f8f8);
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>單幣-建立新單(ver:2025112701)</h2>
        <form id="singleOrderForm">
            <div class="form-group">
                <label for="symbol">標的幣種</label>
                <input type="text" id="symbol" placeholder="如：BTC、ETH" required>
                <select id="chineseSymbolSelect" style="margin-top: 8px; width: 100%; padding: 12px; border: 1px solid var(--tg-theme-hint-color, #cccccc); border-radius: 8px; font-size: 16px; background-color: var(--tg-theme-secondary-bg-color, #f8f8f8); color: var(--tg-theme-text-color, #000000); box-sizing: border-box;">
                    <option value="">-- 或選擇中文標的 --</option>
                </select>
                <div class="price-type-info">可直接輸入英文標的，或從下方選單選擇中文標的</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="period">週期</label>
                    <select id="period" required>
                        <option value="30m">30分鐘</option>
                        <option value="1h" selected>1小時</option>
                        <option value="2h">2小時</option>
                        <option value="4h">4小時</option>
                        <option value="8h">8小時</option>
                        <option value="1d">1天</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="direction">交易方向</label>
                    <select id="direction" required onchange="updateValidationInfo()">
                        <option value="">請選擇</option>
                        <option value="long">作多</option>
                        <option value="short">作空</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="R">R值 (USDT)</label>
                    <input type="number" id="R" placeholder="風險單位，如：10" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="priceType">價格類型</label>
                    <select id="priceType" required onchange="togglePriceInput()">
                        <option value="">請選擇</option>
                        <option value="market">市價單</option>
                        <option value="limit">掛單</option>
                    </select>
                </div>
            </div>

            <div class="form-group" id="orderPriceGroup" style="display: none;">
                <label for="orderPrice">掛單價格</label>
                <input type="number" id="orderPrice" placeholder="掛單價格" step="0.00001" min="0">
                <div class="price-type-info">僅限掛單類型需填寫</div>
            </div>

            <div class="form-group">
                <label for="stopLossPrice">停損價格</label>
                <input type="number" id="stopLossPrice" placeholder="停損價格" step="0.00001" min="0" required onchange="updateValidationInfo()">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="adjustATR">上調停利ATR倍數</label>
                    <input type="number" id="adjustATR" placeholder="如：2.0" step="0.1" min="0.1" value="2.0" required>
                </div>
                <div class="form-group">
                    <label for="leverage">槓桿倍數</label>
                    <input type="number" id="leverage" placeholder="如：10" step="1" min="1" max="125" value="10" required>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="enableScaling">
                <label for="enableScaling">啟用加碼功能</label>
            </div>
            <div class="price-type-info" id="scalingHint" style="display: none; color: var(--tg-theme-hint-color, #999999);">
                ⓘ 加碼功能僅在ATR停損模式可用
            </div>

            <div class="form-group">
                <label for="stopLossMode">停損模式</label>
                <select id="stopLossMode" onchange="toggleStopLossMode()">
                    <option value="none">ATR停損</option>
                    <option value="breakeven">保本停損</option>
                    <option value="trailing">移動停損</option>
                    <option value="preserve_trailing">保本+移動停損</option>
                    <option value="fixed_r">固定R停損</option>
                </select>
            </div>

            <div id="breakevenInputs" style="display: none;">
                <div class="form-group">
                    <label for="breakevenActivationR">保本啟動R數</label>
                    <input type="number" id="breakevenActivationR" placeholder="如：2" step="0.1" min="0.1">
                    <div class="price-type-info">達到此R數時觸發保本停損調整</div>
                </div>
                <div class="form-group">
                    <label for="breakevenR">保本R數</label>
                    <input type="number" id="breakevenR" placeholder="如：0.4" step="0.1" min="0">
                    <div class="price-type-info">停損將調整至此R數位置（0表示成本價）</div>
                </div>
            </div>

            <div id="trailingInputs" style="display: none;">
                <div class="form-group">
                    <label for="trailingActivationR">移動停損啟動R數</label>
                    <input type="number" id="trailingActivationR" placeholder="如：3" step="0.1" min="0.1">
                    <div class="price-type-info">達到此R數時，啟動移動停損</div>
                </div>
                <div class="form-group">
                    <label for="trailingCallbackR">回吐移動R數</label>
                    <input type="number" id="trailingCallbackR" placeholder="如：1.5" step="0.1" min="0.1">
                    <div class="price-type-info">停損 = 最高盈虧 - 此R數</div>
                </div>
            </div>

            <!-- 通用TP欄位（適用於ATR/保本/移動/保本+移動模式） -->
            <div id="takeProfitInput" style="display: none;">
                <div class="form-group">
                    <label for="takeProfitR">獲利目標R數 (TP)</label>
                    <input type="number" id="takeProfitR" placeholder="如：5（可選，0表示不設定）" step="0.1" min="0" value="0">
                    <div class="price-type-info">達到此R數時自動獲利了結（0表示不設定TP，僅依靠停損模式）</div>
                </div>
            </div>

            <div id="fixedRInputs" style="display: none;">
                <div class="form-group">
                    <label for="fixedR">固定R數（獲利目標）</label>
                    <input type="number" id="fixedR" placeholder="如：5" step="0.1" min="0.1">
                    <div class="price-type-info">達到此R數時自動出場</div>
                </div>
                <div class="form-group">
                    <label for="fixedStopLossR">固定停損R數</label>
                    <input type="number" id="fixedStopLossR" placeholder="如：4（當獲利6R時，停損設4R保護）" step="0.1" value="-1">
                    <div class="price-type-info">盈虧達到此R數時停損出場（可為正數或負數，例如：當前6R設停損4R，或虧損設-1R）</div>
                </div>
            </div>

            <div class="validation-info" id="validationInfo" style="display: none;">
                <!-- 動態顯示驗證資訊 -->
            </div>

            <button type="button" class="submit-btn" onclick="submitOrder()">建立訂單</button>
            <button type="button" class="cancel-btn" onclick="cancelOrder()">取消</button>
        </form>
    </div>

    <script>
        // 初始化 Telegram WebApp
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();

        function togglePriceInput() {
            const priceType = document.getElementById('priceType').value;
            const orderPriceGroup = document.getElementById('orderPriceGroup');
            const orderPriceInput = document.getElementById('orderPrice');

            if (priceType === 'limit') {
                orderPriceGroup.style.display = 'block';
                orderPriceInput.required = true;
            } else {
                orderPriceGroup.style.display = 'none';
                orderPriceInput.required = false;
                orderPriceInput.value = '';
            }
            updateValidationInfo();
        }

        function toggleStopLossMode() {
            const mode = document.getElementById('stopLossMode').value;
            const breakevenInputs = document.getElementById('breakevenInputs');
            const trailingInputs = document.getElementById('trailingInputs');
            const fixedRInputs = document.getElementById('fixedRInputs');
            const takeProfitInput = document.getElementById('takeProfitInput');
            const enableScalingCheckbox = document.getElementById('enableScaling');
            const scalingHint = document.getElementById('scalingHint');

            // 隱藏所有輸入區域
            breakevenInputs.style.display = 'none';
            trailingInputs.style.display = 'none';
            fixedRInputs.style.display = 'none';
            takeProfitInput.style.display = 'none';

            // 根據模式顯示對應的輸入區域
            if (mode === 'breakeven' || mode === 'preserve_trailing') {
                breakevenInputs.style.display = 'block';
            }

            if (mode === 'trailing' || mode === 'preserve_trailing') {
                trailingInputs.style.display = 'block';
            }

            if (mode === 'fixed_r') {
                fixedRInputs.style.display = 'block';
            }

            // 顯示通用TP欄位（ATR/保本/移動/保本+移動模式）
            if (mode === 'none' || mode === 'breakeven' || mode === 'trailing' || mode === 'preserve_trailing') {
                takeProfitInput.style.display = 'block';
            }

            // 加碼功能只在ATR停損模式可用
            if (mode === 'none') {
                // ATR停損模式：啟用加碼選項
                enableScalingCheckbox.disabled = false;
                scalingHint.style.display = 'none';
            } else {
                // 保本/移動/保本+移動/固定R停損模式：停用加碼選項
                enableScalingCheckbox.disabled = true;
                enableScalingCheckbox.checked = false;
                scalingHint.style.display = 'block';
            }

            updateValidationInfo();
        }

        function updateValidationInfo() {
            const direction = document.getElementById('direction').value;
            const priceType = document.getElementById('priceType').value;
            const orderPrice = parseFloat(document.getElementById('orderPrice').value);
            const stopLossPrice = parseFloat(document.getElementById('stopLossPrice').value);
            const validationInfo = document.getElementById('validationInfo');

            if (!direction || !stopLossPrice || (priceType === 'limit' && !orderPrice)) {
                validationInfo.style.display = 'none';
                return;
            }

            let infoText = '';
            let isValid = true;

            if (direction === 'long') {
                infoText = '作多規則：';
                if (priceType === 'limit') {
                    if (orderPrice > stopLossPrice) {
                        infoText += `✅ 掛單價(${orderPrice}) > 停損價(${stopLossPrice})`;
                    } else {
                        infoText += `❌ 掛單價(${orderPrice}) 應大於停損價(${stopLossPrice})`;
                        isValid = false;
                    }
                } else {
                    infoText += ' 市價單將以當前市場價格執行';
                }
            } else if (direction === 'short') {
                infoText = '作空規則：';
                if (priceType === 'limit') {
                    if (orderPrice < stopLossPrice) {
                        infoText += `✅ 掛單價(${orderPrice}) < 停損價(${stopLossPrice})`;
                    } else {
                        infoText += `❌ 掛單價(${orderPrice}) 應小於停損價(${stopLossPrice})`;
                        isValid = false;
                    }
                } else {
                    infoText += ' 市價單將以當前市場價格執行';
                }
            }

            validationInfo.textContent = infoText;
            validationInfo.style.display = 'block';
            validationInfo.style.color = isValid ? 'var(--tg-theme-hint-color, #999999)' : 'var(--tg-theme-destructive-text-color, #ff3b30)';

            return isValid;
        }

        function validateForm() {
            const symbol = document.getElementById('symbol').value.trim();
            const period = document.getElementById('period').value;
            const direction = document.getElementById('direction').value;
            const R = parseFloat(document.getElementById('R').value);
            const priceType = document.getElementById('priceType').value;
            const orderPrice = document.getElementById('orderPrice').value;
            const stopLossPrice = parseFloat(document.getElementById('stopLossPrice').value);
            const adjustATR = parseFloat(document.getElementById('adjustATR').value);
            const leverage = parseInt(document.getElementById('leverage').value);
            const stopLossMode = document.getElementById('stopLossMode').value;

            // 基本欄位檢查
            if (!symbol || !period || !direction || !R || !priceType || !stopLossPrice || !adjustATR || !leverage) {
                alert('請填寫所有必填欄位');
                return false;
            }

            // 掛單價格檢查
            if (priceType === 'limit' && !orderPrice) {
                alert('掛單類型必須填寫掛單價格');
                return false;
            }

            // 價格邏輯驗證
            if (priceType === 'limit') {
                const orderPriceNum = parseFloat(orderPrice);
                if (direction === 'long' && orderPriceNum <= stopLossPrice) {
                    alert('作多時，掛單價格必須大於停損價格');
                    return false;
                }
                if (direction === 'short' && orderPriceNum >= stopLossPrice) {
                    alert('作空時，掛單價格必須小於停損價格');
                    return false;
                }
            }

            // 數值範圍檢查
            if (R <= 0 || stopLossPrice <= 0 || adjustATR <= 0 || leverage < 1 || leverage > 125) {
                alert('請確認數值範圍正確');
                return false;
            }

            // 停損模式驗證
            if (stopLossMode === 'breakeven' || stopLossMode === 'preserve_trailing') {
                const breakevenActivationR = parseFloat(document.getElementById('breakevenActivationR').value);
                const breakevenR = parseFloat(document.getElementById('breakevenR').value);
                if (!breakevenActivationR || breakevenActivationR <= 0) {
                    alert('請輸入有效的保本啟動R數');
                    return false;
                }
                if (breakevenR === null || breakevenR === undefined || isNaN(breakevenR) || breakevenR < 0) {
                    alert('請輸入有效的保本R數（可為0）');
                    return false;
                }
            }

            if (stopLossMode === 'trailing' || stopLossMode === 'preserve_trailing') {
                const trailingR = parseFloat(document.getElementById('trailingActivationR').value);
                const callbackR = parseFloat(document.getElementById('trailingCallbackR').value);
                if (!trailingR || trailingR <= 0) {
                    alert('請輸入有效的移動停損啟動R數');
                    return false;
                }
                if (!callbackR || callbackR <= 0) {
                    alert('請輸入有效的回吐移動R數');
                    return false;
                }
            }

            // 保本+移動停損的參數驗證
            if (stopLossMode === 'preserve_trailing') {
                const breakevenR = parseFloat(document.getElementById('breakevenActivationR').value);
                const trailingR = parseFloat(document.getElementById('trailingActivationR').value);
                if (breakevenR > trailingR) {
                    alert('保本啟動R數不可大於移動停損啟動R數');
                    return false;
                }
            }

            // 固定R停損的參數驗證
            if (stopLossMode === 'fixed_r') {
                const fixedR = parseFloat(document.getElementById('fixedR').value);
                const fixedStopLossR = parseFloat(document.getElementById('fixedStopLossR').value);

                if (!fixedR || fixedR <= 0) {
                    alert('請輸入有效的固定R數（獲利目標）');
                    return false;
                }

                if (isNaN(fixedStopLossR)) {
                    alert('請輸入有效的固定停損R數');
                    return false;
                }

                if (fixedStopLossR >= fixedR) {
                    alert('固定停損R數必須小於固定R數（獲利目標）');
                    return false;
                }
            }

            return true;
        }

        function submitOrder() {
            if (!validateForm()) {
                return;
            }

            // 在提交前保存表單狀態
            saveFormState();

            const stopLossMode = document.getElementById('stopLossMode').value;

            const formData = {
                symbol: document.getElementById('symbol').value.trim().toUpperCase(),
                period: document.getElementById('period').value,
                direction: document.getElementById('direction').value,
                R: document.getElementById('R').value,
                priceType: document.getElementById('priceType').value,
                orderPrice: document.getElementById('orderPrice').value || '',
                stopLossPrice: document.getElementById('stopLossPrice').value,
                adjustATR: document.getElementById('adjustATR').value,
                leverage: document.getElementById('leverage').value,
                enableScaling: document.getElementById('enableScaling').checked
            };

            // 根據停損模式加入相關參數
            if (stopLossMode === 'breakeven' || stopLossMode === 'preserve_trailing') {
                formData.enableBreakeven = 'true';
                formData.breakevenActivationR = document.getElementById('breakevenActivationR').value;
                formData.breakevenR = document.getElementById('breakevenR').value;
            } else {
                formData.enableBreakeven = 'false';
                formData.breakevenActivationR = '0';
                formData.breakevenR = '0';
            }

            if (stopLossMode === 'trailing' || stopLossMode === 'preserve_trailing') {
                formData.enableTrailing = 'true';
                formData.trailingActivationR = document.getElementById('trailingActivationR').value;
                formData.trailingCallbackR = document.getElementById('trailingCallbackR').value;
            } else {
                formData.enableTrailing = 'false';
                formData.trailingActivationR = '0';
                formData.trailingCallbackR = '0';
            }

            if (stopLossMode === 'fixed_r') {
                formData.enableFixedR = 'true';
                formData.fixedR = document.getElementById('fixedR').value;
                formData.fixedStopLossR = document.getElementById('fixedStopLossR').value;
                formData.takeProfitR = '0';  // 固定R模式不使用通用TP
            } else {
                formData.enableFixedR = 'false';
                formData.fixedR = '0';
                formData.fixedStopLossR = '-1';
                // 其他模式使用通用TP欄位
                formData.takeProfitR = document.getElementById('takeProfitR').value || '0';
            }

            // 將表單資料轉換為字串格式，類似現有的多空單格式
            const dataString = Object.entries(formData)
                .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
                .join('&');

            // 發送資料到 Telegram
            window.Telegram.WebApp.sendData(dataString);
        }

        function cancelOrder() {
            window.Telegram.WebApp.sendData('cancelSingleOrder');
        }

        // 自動儲存表單狀態
        function saveFormState() {
            const formData = {
                symbol: document.getElementById('symbol').value,
                period: document.getElementById('period').value,
                direction: document.getElementById('direction').value,
                R: document.getElementById('R').value,
                priceType: document.getElementById('priceType').value,
                orderPrice: document.getElementById('orderPrice').value,
                stopLossPrice: document.getElementById('stopLossPrice').value,
                adjustATR: document.getElementById('adjustATR').value,
                leverage: document.getElementById('leverage').value,
                enableScaling: document.getElementById('enableScaling').checked,
                stopLossMode: document.getElementById('stopLossMode').value,
                breakevenActivationR: document.getElementById('breakevenActivationR').value,
                breakevenR: document.getElementById('breakevenR').value,
                trailingActivationR: document.getElementById('trailingActivationR').value,
                trailingCallbackR: document.getElementById('trailingCallbackR').value,
                fixedR: document.getElementById('fixedR').value,
                fixedStopLossR: document.getElementById('fixedStopLossR').value,
                takeProfitR: document.getElementById('takeProfitR').value
            };
            localStorage.setItem('singleOrderForm', JSON.stringify(formData));
        }

        function loadFormState() {
            const saved = localStorage.getItem('singleOrderForm');
            if (saved) {
                const formData = JSON.parse(saved);
                document.getElementById('symbol').value = formData.symbol || '';
                document.getElementById('period').value = formData.period || '1h';
                document.getElementById('direction').value = formData.direction || '';
                document.getElementById('R').value = formData.R || '';
                document.getElementById('priceType').value = formData.priceType || '';
                document.getElementById('orderPrice').value = formData.orderPrice || '';
                document.getElementById('stopLossPrice').value = formData.stopLossPrice || '';
                document.getElementById('adjustATR').value = formData.adjustATR || '2.0';
                document.getElementById('leverage').value = formData.leverage || '10';
                document.getElementById('enableScaling').checked = formData.enableScaling || false;
                document.getElementById('stopLossMode').value = formData.stopLossMode || 'none';
                document.getElementById('breakevenActivationR').value = formData.breakevenActivationR || '';
                document.getElementById('breakevenR').value = formData.breakevenR || '';
                document.getElementById('trailingActivationR').value = formData.trailingActivationR || '';
                document.getElementById('trailingCallbackR').value = formData.trailingCallbackR || '';
                document.getElementById('fixedR').value = formData.fixedR || '';
                document.getElementById('fixedStopLossR').value = formData.fixedStopLossR || '-1';
                document.getElementById('takeProfitR').value = formData.takeProfitR || '0';

                // 觸發相關的更新邏輯
                togglePriceInput();
                toggleStopLossMode();
                updateValidationInfo();
            }
        }

        // 載入中文標的列表
        async function loadChineseSymbols() {
            try {
                const response = await fetch('https://gist.githubusercontent.com/twhiroshi/992853f4f26375b33235617f69332e58/raw/chinese_symbol.json');
                const symbols = await response.json();

                const select = document.getElementById('chineseSymbolSelect');
                symbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('載入中文標的失敗:', error);
            }
        }

        // 當選擇中文標的時，填入輸入框
        document.getElementById('chineseSymbolSelect').addEventListener('change', function() {
            const selectedSymbol = this.value;
            if (selectedSymbol) {
                document.getElementById('symbol').value = selectedSymbol;
                this.value = ''; // 清空選單
                saveFormState(); // 儲存狀態
            }
        });

        // 頁面載入時恢復表單狀態
        document.addEventListener('DOMContentLoaded', function() {
            loadFormState();
            loadChineseSymbols(); // 載入中文標的

            // 監聽表單變化並自動儲存
            document.getElementById('singleOrderForm').addEventListener('change', saveFormState);
        });
    </script>
</body>
</html>