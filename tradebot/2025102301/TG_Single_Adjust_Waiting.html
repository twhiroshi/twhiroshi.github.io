<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單幣-修改倉位(掛單)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 20px;
            line-height: 1.4;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .info-group {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 8px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }
        .info-label {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
            margin-bottom: 3px;
        }
        .info-value {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 6px;
            font-size: 16px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            box-sizing: border-box;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .btn-danger {
            background-color: #ff3b30;
            color: white;
        }
        .btn-secondary {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }
        .version {
            text-align: center;
            color: var(--tg-theme-hint-color, #999999);
            font-size: 12px;
            margin-top: 10px;
        }
        .form-row {
            display: flex;
            gap: 10px;
        }
        .form-row .form-group {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>單幣-修改倉位(掛單)(ver:2025102301)</h2>
        
        <!-- 訂單基本資訊 -->
        <div class="info-group">
            <h3>掛單資訊</h3>
            <div class="info-label">訂單編號</div>
            <div class="info-value" id="orderId"></div>
            
            <div class="info-label">交易標的</div>
            <div class="info-value" id="symbolDirection"></div>
            
            <div class="info-label">計畫數量</div>
            <div class="info-value" id="plannedQuantity"></div>
        </div>
        
        <!-- 可修改參數 -->
        <div class="form-group">
            <label for="targetPrice">目標價格 (觸發進場價格)</label>
            <input type="number" id="targetPrice" step="0.01" placeholder="輸入目標價格">
        </div>
        
        <div class="form-group">
            <label for="stopLossPrice">停損價格</label>
            <input type="number" id="stopLossPrice" step="0.01" placeholder="輸入停損價格">
        </div>
        
        <div class="form-group">
            <label for="adjustATR">ATR 倍數</label>
            <input type="number" id="adjustATR" step="0.1" min="0.1" max="5.0" placeholder="輸入 ATR 倍數">
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="leverage">槓桿倍數</label>
                <select id="leverage">
                    <option value="1">1x</option>
                    <option value="2">2x</option>
                    <option value="3">3x</option>
                    <option value="5">5x</option>
                    <option value="10">10x</option>
                    <option value="20">20x</option>
                    <option value="50">50x</option>
                    <option value="100">100x</option>
                    <option value="125">125x</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="period">週期</label>
                <select id="period" required>
                    <option value="30m">30分鐘</option>
                    <option value="1h" selected>1小時</option>
                    <option value="2h">2小時</option>
                    <option value="4h">4小時</option>
                    <option value="8h">8小時</option>
                    <option value="1d">1天</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="enableScaling">加碼設定</label>
            <select id="enableScaling">
                <option value="false">停用加碼</option>
                <option value="true">啟用加碼</option>
            </select>
        </div>
        <div style="font-size: 12px; color: var(--tg-theme-hint-color, #999999); margin-top: -10px; margin-bottom: 15px;" id="scalingHint">
            ⓘ 加碼功能僅在ATR停損模式可用
        </div>

        <div class="form-group">
            <label for="stopLossMode">停損模式</label>
            <select id="stopLossMode" onchange="toggleStopLossMode()">
                <option value="none">ATR停損</option>
                <option value="breakeven">保本停損</option>
                <option value="trailing">移動停損</option>
                <option value="preserve_trailing">保本+移動停損</option>
                <option value="fixed_r">固定R停損</option>
            </select>
        </div>

        <div id="breakevenInputs" style="display: none;">
            <div class="form-group">
                <label for="breakevenActivationR">保本啟動R數</label>
                <input type="number" id="breakevenActivationR" placeholder="如：2" step="0.1" min="0.1">
            </div>
            <div class="form-group">
                <label for="breakevenR">保本R數</label>
                <input type="number" id="breakevenR" placeholder="如：0.4" step="0.1" min="0">
            </div>
        </div>

        <div id="trailingInputs" style="display: none;">
            <div class="form-group">
                <label for="trailingActivationR">移動停損啟動R數</label>
                <input type="number" id="trailingActivationR" placeholder="如：3" step="0.1" min="0.1">
            </div>
            <div class="form-group">
                <label for="trailingCallbackR">回吐移動R數</label>
                <input type="number" id="trailingCallbackR" placeholder="如：1.5" step="0.1" min="0.1">
            </div>
        </div>

        <div id="fixedRInputs" style="display: none;">
            <div class="form-group">
                <label for="fixedR">固定R數（獲利目標）</label>
                <input type="number" id="fixedR" placeholder="如：5" step="0.1" min="0.1">
                <div style="font-size: 12px; color: var(--tg-theme-hint-color, #999999); margin-top: 5px;">達到此R數時自動出場</div>
            </div>
            <div class="form-group">
                <label for="fixedStopLossR">固定停損R數</label>
                <input type="number" id="fixedStopLossR" placeholder="如：4（當獲利6R時，停損設4R保護）" step="0.1" value="-1">
                <div style="font-size: 12px; color: var(--tg-theme-hint-color, #999999); margin-top: 5px;">盈虧達到此R數時停損出場（可為正數或負數，例如：當前6R設停損4R，或虧損設-1R）</div>
            </div>
        </div>

        <!-- 操作按鈕 -->
        <div class="button-group">
            <button class="btn btn-primary" onclick="submitModification()">確認修改</button>
        </div>
        
        <div class="button-group">
            <button class="btn btn-danger" onclick="cancelOrder()">取消掛單</button>
            <button class="btn btn-secondary" onclick="cancelOperation()">取消操作</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let orderData = {};
        
        function initForm() {
            tg.ready();
            tg.expand();
            
            // 從 URL 參數獲取訂單資訊
            const urlParams = new URLSearchParams(window.location.search);
            orderData = {
                id: urlParams.get('id') || '',
                symbol: decodeURIComponent(urlParams.get('symbol') || ''),
                direction: urlParams.get('direction') || '',
                targetPrice: urlParams.get('targetPrice') || '',
                stopLossPrice: urlParams.get('stopLossPrice') || '',
                adjustATR: urlParams.get('adjustATR') || '',
                leverage: urlParams.get('leverage') || '',
                period: urlParams.get('period') || '',
                enableScaling: urlParams.get('enableScaling') || '',
                plannedQuantity: urlParams.get('plannedQuantity') || '',
                enableBreakeven: urlParams.get('enableBreakeven') || 'false',
                breakevenActivationR: urlParams.get('breakevenActivationR') || '',
                breakevenR: urlParams.get('breakevenR') || '',
                enableTrailing: urlParams.get('enableTrailing') || 'false',
                trailingActivationR: urlParams.get('trailingActivationR') || '',
                trailingCallbackR: urlParams.get('trailingCallbackR') || '',
                enableFixedR: urlParams.get('enableFixedR') || 'false',
                fixedR: urlParams.get('fixedR') || '',
                fixedStopLossR: urlParams.get('fixedStopLossR') || '-1'
            };
            
            // 填入訂單資訊
            document.getElementById('orderId').textContent = orderData.id;
            document.getElementById('symbolDirection').textContent = `${orderData.symbol} (${orderData.direction === 'long' ? '作多' : '作空'})`;
            document.getElementById('plannedQuantity').textContent = orderData.plannedQuantity;
            
            // 設定當前參數值
            document.getElementById('targetPrice').value = orderData.targetPrice;
            document.getElementById('stopLossPrice').value = orderData.stopLossPrice;
            document.getElementById('adjustATR').value = orderData.adjustATR;
            document.getElementById('leverage').value = orderData.leverage;
            document.getElementById('period').value = orderData.period;
            document.getElementById('enableScaling').value = orderData.enableScaling;

            // 設定停損模式
            const enableBreakeven = orderData.enableBreakeven === 'true';
            const enableTrailing = orderData.enableTrailing === 'true';
            const enableFixedR = orderData.enableFixedR === 'true';

            let stopLossMode = 'none';
            if (enableFixedR) {
                stopLossMode = 'fixed_r';
            } else if (enableBreakeven && enableTrailing) {
                stopLossMode = 'preserve_trailing';
            } else if (enableBreakeven) {
                stopLossMode = 'breakeven';
            } else if (enableTrailing) {
                stopLossMode = 'trailing';
            }

            document.getElementById('stopLossMode').value = stopLossMode;
            document.getElementById('breakevenActivationR').value = orderData.breakevenActivationR;
            document.getElementById('breakevenR').value = orderData.breakevenR;
            document.getElementById('trailingActivationR').value = orderData.trailingActivationR;
            document.getElementById('trailingCallbackR').value = orderData.trailingCallbackR;
            document.getElementById('fixedR').value = orderData.fixedR;
            document.getElementById('fixedStopLossR').value = orderData.fixedStopLossR;

            toggleStopLossMode();
        }

        function toggleStopLossMode() {
            const mode = document.getElementById('stopLossMode').value;
            const breakevenInputs = document.getElementById('breakevenInputs');
            const trailingInputs = document.getElementById('trailingInputs');
            const fixedRInputs = document.getElementById('fixedRInputs');
            const enableScalingSelect = document.getElementById('enableScaling');
            const scalingHint = document.getElementById('scalingHint');

            breakevenInputs.style.display = 'none';
            trailingInputs.style.display = 'none';
            fixedRInputs.style.display = 'none';

            if (mode === 'breakeven' || mode === 'preserve_trailing') {
                breakevenInputs.style.display = 'block';
            }

            if (mode === 'trailing' || mode === 'preserve_trailing') {
                trailingInputs.style.display = 'block';
            }

            if (mode === 'fixed_r') {
                fixedRInputs.style.display = 'block';
            }

            // 加碼功能只在ATR停損模式可用
            if (mode === 'none') {
                // ATR停損模式：啟用加碼選項
                enableScalingSelect.disabled = false;
                scalingHint.style.display = 'none';
            } else {
                // 保本/移動/保本+移動/固定R停損模式：停用加碼選項並強制設為false
                enableScalingSelect.disabled = true;
                enableScalingSelect.value = 'false';
                scalingHint.style.display = 'block';
            }
        }
        
        function submitModification() {
            const targetPrice = document.getElementById('targetPrice').value;
            const stopLossPrice = document.getElementById('stopLossPrice').value;
            const adjustATR = document.getElementById('adjustATR').value;
            const leverage = document.getElementById('leverage').value;
            const period = document.getElementById('period').value;
            const enableScaling = document.getElementById('enableScaling').value;
            const stopLossMode = document.getElementById('stopLossMode').value;

            // 基本驗證
            if (!targetPrice || !stopLossPrice || !adjustATR) {
                alert('請填入必要參數：目標價格、停損價格、ATR倍數');
                return;
            }

            if (adjustATR < 0.1 || adjustATR > 5.0) {
                alert('ATR 倍數必須在 0.1-5.0 之間');
                return;
            }

            // 價格邏輯驗證
            const target = parseFloat(targetPrice);
            const stopLoss = parseFloat(stopLossPrice);

            if (orderData.direction === 'long' && stopLoss >= target) {
                alert('作多時停損價格必須低於目標價格');
                return;
            }

            if (orderData.direction === 'short' && stopLoss <= target) {
                alert('作空時停損價格必須高於目標價格');
                return;
            }

            // 停損模式驗證
            let enableBreakeven = 'false';
            let breakevenActivationR = '0';
            let breakevenR = '0';
            let enableTrailing = 'false';
            let trailingActivationR = '0';
            let trailingCallbackR = '0';
            let enableFixedR = 'false';
            let fixedR = '0';
            let fixedStopLossR = '-1';

            if (stopLossMode === 'breakeven' || stopLossMode === 'preserve_trailing') {
                enableBreakeven = 'true';
                breakevenActivationR = document.getElementById('breakevenActivationR').value;
                breakevenR = document.getElementById('breakevenR').value;
                if (!breakevenActivationR || parseFloat(breakevenActivationR) <= 0) {
                    alert('請輸入有效的保本啟動R數');
                    return;
                }
                if (breakevenR === null || breakevenR === undefined || breakevenR === '' || isNaN(parseFloat(breakevenR)) || parseFloat(breakevenR) < 0) {
                    alert('請輸入有效的保本R數（可為0）');
                    return;
                }
            }

            if (stopLossMode === 'trailing' || stopLossMode === 'preserve_trailing') {
                enableTrailing = 'true';
                trailingActivationR = document.getElementById('trailingActivationR').value;
                trailingCallbackR = document.getElementById('trailingCallbackR').value;
                if (!trailingActivationR || parseFloat(trailingActivationR) <= 0) {
                    alert('請輸入有效的移動停損啟動R數');
                    return;
                }
                if (!trailingCallbackR || parseFloat(trailingCallbackR) <= 0) {
                    alert('請輸入有效的回吐移動R數');
                    return;
                }
            }

            // 固定R停損的參數驗證
            if (stopLossMode === 'fixed_r') {
                enableFixedR = 'true';
                fixedR = document.getElementById('fixedR').value;
                fixedStopLossR = document.getElementById('fixedStopLossR').value;

                if (!fixedR || parseFloat(fixedR) <= 0) {
                    alert('請輸入有效的固定R數（獲利目標）');
                    return;
                }

                if (isNaN(parseFloat(fixedStopLossR))) {
                    alert('請輸入有效的固定停損R數');
                    return;
                }

                if (parseFloat(fixedStopLossR) >= parseFloat(fixedR)) {
                    alert('固定停損R數必須小於固定R數（獲利目標）');
                    return;
                }
            }

            // 保本+移動停損驗證
            if (stopLossMode === 'preserve_trailing') {
                if (parseFloat(breakevenActivationR) > parseFloat(trailingActivationR)) {
                    alert('保本啟動R數不可大於移動停損啟動R數');
                    return;
                }
            }

            let stopLossModeText = 'ATR停損';
            if (stopLossMode === 'breakeven') stopLossModeText = '保本停損';
            else if (stopLossMode === 'trailing') stopLossModeText = '移動停損';
            else if (stopLossMode === 'preserve_trailing') stopLossModeText = '保本+移動停損';
            else if (stopLossMode === 'fixed_r') stopLossModeText = '固定R停損';

            const confirmMessage = `確認修改掛單參數？\n目標價格: ${targetPrice}\n停損價格: ${stopLossPrice}\nATR倍數: ${adjustATR}\n槓桿: ${leverage}x\n週期: ${period}\n加碼: ${enableScaling === 'true' ? '啟用' : '停用'}\n停損模式: ${stopLossModeText}`;

            if (confirm(confirmMessage)) {
                const data = `id=${orderData.id}&targetPrice=${targetPrice}&stopLossPrice=${stopLossPrice}&adjustATR=${adjustATR}&leverage=${leverage}&period=${period}&enableScaling=${enableScaling}&enableBreakeven=${enableBreakeven}&breakevenActivationR=${breakevenActivationR}&breakevenR=${breakevenR}&enableTrailing=${enableTrailing}&trailingActivationR=${trailingActivationR}&trailingCallbackR=${trailingCallbackR}&enableFixedR=${enableFixedR}&fixedR=${fixedR}&fixedStopLossR=${fixedStopLossR}`;
                tg.sendData(data);
            }
        }
        
        function cancelOrder() {
            const confirmMessage = `確認取消掛單 ${orderData.symbol} ${orderData.direction === 'long' ? '作多' : '作空'}？`;
            if (confirm(confirmMessage)) {
                const data = `cancelOrder=${orderData.id}`;
                tg.sendData(data);
            }
        }
        
        function cancelOperation() {
            tg.sendData('cancelOperation');
        }
        
        // 初始化表單
        window.onload = initForm;
    </script>
</body>
</html>